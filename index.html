<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazon Subscribe & Save</title>
  <link rel="icon" href="https://www.amazon.com/favicon.ico">
  <link rel="apple-touch-icon" href="https://www.amazon.com/favicon.ico">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; padding: 20px; }
    .header-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    h1 { font-size: 1.5rem; }
    .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #999; transition: background 0.3s; flex-shrink: 0; }
    .sync-dot.connected { background: #4caf50; }
    .subtitle { color: #666; margin-bottom: 6px; font-size: 0.9rem; }
    .deadline { color: #d32f2f; font-weight: 600; margin-bottom: 16px; font-size: 0.9rem; }
    .controls { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
    .controls button { padding: 8px 14px; border: 1px solid #ccc; border-radius: 6px; background: #fff; cursor: pointer; font-size: 0.82rem; }
    .controls button:hover { background: #e8e8e8; }
    .controls button.primary { background: #ff9900; color: #fff; border-color: #e88a00; font-weight: 600; }
    .controls button.primary:hover { background: #e88a00; }
    .summary { background: #fff; border-radius: 8px; padding: 12px 16px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); font-size: 0.9rem; }
    .summary span { font-weight: 600; }
    .item-list { list-style: none; }
    .group-divider { padding: 10px 16px 6px; font-size: 0.8rem; font-weight: 600; color: #555; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #ddd; margin-top: 18px; margin-bottom: 6px; }
    .group-divider:first-child { margin-top: 0; }
    .item { background: #fff; border-radius: 8px; padding: 12px 16px; margin-bottom: 6px; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); transition: opacity 0.2s; }
    .item.unchecked { opacity: 0.45; }
    .item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: #ff9900; flex-shrink: 0; margin-top: 2px; }
    .item-num { font-size: 0.8rem; color: #999; width: 24px; text-align: right; flex-shrink: 0; margin-top: 2px; }
    .item-details { flex: 1; min-width: 0; }
    .item-name { font-weight: 500; font-size: 0.95rem; }
    .item-meta { font-size: 0.8rem; color: #777; margin-top: 2px; }
    .item-price { font-weight: 600; color: #111; white-space: nowrap; flex-shrink: 0; margin-top: 2px; }
    .unavailable { color: #d32f2f; font-style: italic; font-size: 0.8rem; }
    .vet-note { color: #e65100; font-style: italic; font-size: 0.8rem; }
    .search { padding: 8px 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 0.9rem; width: 180px; }
    .toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 24px; border-radius: 8px; font-size: 0.9rem; z-index: 999; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    .toast.show { opacity: 1; }
    .alt-toggle { font-size: 0.8rem; color: #146eb4; cursor: pointer; margin-top: 4px; display: inline-block; }
    .alt-toggle:hover { text-decoration: underline; }
    .alt-list { margin-top: 6px; padding: 8px 12px; background: #f9f9f9; border-radius: 6px; font-size: 0.82rem; display: none; }
    .alt-list.open { display: block; }
    .alt-item { display: flex; align-items: center; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #eee; }
    .alt-item:last-child { border-bottom: none; }
    .alt-info { flex: 1; }
    .alt-name { font-weight: 500; }
    .alt-meta { color: #777; font-size: 0.78rem; }
    .alt-savings { color: #1e7e34; font-weight: 600; font-size: 0.78rem; }
    .alt-switch { padding: 3px 10px; border: 1px solid #146eb4; border-radius: 4px; background: #fff; color: #146eb4; cursor: pointer; font-size: 0.75rem; margin-left: 8px; }
    .alt-switch:hover { background: #e8f0fe; }
    .alt-switch.selected { background: #146eb4; color: #fff; }
    .pref-alt { color: #146eb4; font-size: 0.78rem; margin-left: 6px; }
    .cancel-btn { background: none; border: none; color: #d32f2f; font-size: 1.1rem; cursor: pointer; padding: 2px 6px; line-height: 1; opacity: 0.4; transition: opacity 0.2s; flex-shrink: 0; margin-top: 1px; }
    .cancel-btn:hover { opacity: 1; }
    .item.cancelled { opacity: 0.35; }
    .item.cancelled .item-name { text-decoration: line-through; color: #999; }
    .cancel-label { color: #d32f2f; font-size: 0.75rem; font-weight: 500; margin-left: 8px; }
    .price-badge { font-size: 0.72rem; color: #1e7e34; font-weight: 500; margin-left: 6px; }
    .last-checked { font-size: 0.7rem; color: #aaa; margin-left: 6px; }
  </style>
</head>
<body>
  <div class="header-row">
    <h1>Amazon Subscribe & Save</h1>
    <span class="sync-dot" id="syncDot" title="Offline"></span>
  </div>
  <div class="subtitle">March 10, 2026 Delivery &mdash; <span id="itemCount">44</span> items</div>
  <div class="deadline">Last day to edit: Wednesday, March 4</div>

  <div class="controls">
    <button onclick="selectAll()">Select All</button>
    <button onclick="deselectAll()">Deselect All</button>
<button class="primary" onclick="sendSelections()">Send</button>
    <input type="text" class="search" placeholder="Filter items..." oninput="filterItems(this.value)">
  </div>

  <div class="summary" id="summary"></div>

  <ul class="item-list" id="itemList"></ul>

  <div class="toast" id="toast"></div>

  <script>
    // ========== Item Data ==========
    const items = [
      { id: 13, name: "Presto! Toilet Paper (24 Family Mega Rolls)", price: "$24.64", qty: 3, freq: "1 month", alternatives: [] },
      { id: 43, name: "Lavazza Espresso Whole Bean Coffee (2-pack)", price: "$34.19", qty: 2, freq: "1 month", alternatives: [] },
      { id: 32, name: "Purina Friskies Variety Pack Cat Food (40 cans)", price: "$31.12", qty: 2, freq: "1 month", alternatives: [] },
      { id: 18, name: "Purina Friskies Shreds Cat Food (24 cans)", price: "$19.15", qty: 2, freq: "1 month", alternatives: [] },
      { id: 5, name: "Presto! Paper Towels (12 Huge Rolls)", price: "$25.49", qty: 1, freq: "1 month", alternatives: [] },
      { id: 35, name: "Blue Diamond Dark Chocolate Almonds (25 oz)", price: "$9.76", qty: 2, freq: "1 month", alternatives: [] },
      { id: 10, name: "Purina Cat Chow Naturals Indoor (13 lb)", price: "$16.13", qty: 1, freq: "1 month", alternatives: [] },
      { id: 20, name: "Terrasoul Organic Sunflower Seeds (2 lbs)", price: "$13.49", qty: 1, freq: "1 month", alternatives: [] },
      { id: 31, name: "Happy Belly Roasted Almonds (24 oz)", price: "$7.56", qty: 1, freq: "1 month", alternatives: [] },
      { id: 22, name: "Blue Diamond Wasabi & Soy Sauce Almonds (16 oz)", price: "$6.79", qty: 1, freq: "1 month", alternatives: [] },
      { id: 30, name: "Purina ONE Dog Food Beef & Salmon (27.5 lb)", price: "", qty: 1, freq: "1 month", alternatives: [] },
      { id: 29, name: "Har Bracha Tahini Paste (12 pack)", price: "$94.97", qty: 1, freq: "2 months", alternatives: [] },
      { id: 3, name: "Lavazza Super Crema Whole Bean Coffee (2.2 lb)", price: "$31.43", qty: 1, freq: "2 months", alternatives: [] },
      { id: 1, name: "Mucinex 12 Hour Maximum Strength 1200mg (48 tablets)", price: "$27.79", qty: 1, freq: "2 months", alternatives: [] },
      { id: 28, name: "PUREPLUS 9690 Refrigerator Water Filter (4 pack)", price: "$27.38", qty: 1, freq: "2 months", alternatives: [] },
      { id: 41, name: "Amazon Basics Liquid Hand Soap Refill (2-pack)", price: "$8.02", qty: 1, freq: "2 months", alternatives: [] },
      { id: 33, name: "Downy CALM Mega Dryer Sheets Lavender (130 ct)", price: "$7.35", qty: 1, freq: "2 months", alternatives: [] },
      { id: 9, name: "Hill's Prescription Diet t/d Cat Food (8.5 lb)", price: "", qty: 1, freq: "2 months", alternatives: [] },
      { id: 14, name: "Gillette Clinical Deodorant Cool Wave (3-pack)", price: "$43.32", qty: 2, freq: "3 months", alternatives: [] },
      { id: 40, name: "Endangered Species Dark Chocolate 88% (12 bars)", price: "$47.49", qty: 1, freq: "3 months", alternatives: [] },
      { id: 26, name: "Triple Strength Fish Oil Omega 3 (180 softgels)", price: "$45.01", qty: 1, freq: "3 months", alternatives: [] },
      { id: 47, name: "Brawny Tear-A-Square Paper Towels (12 XL Rolls)", price: "$26.77", qty: 1, freq: "3 months", alternatives: [] },
      { id: 21, name: "Energizer Ultimate Lithium 9V (2 pack)", price: "$26.50", qty: 1, freq: "3 months", alternatives: [] },
      { id: 27, name: "Vicks VapoShower Plus (12 count)", price: "$21.79", qty: 1, freq: "3 months", alternatives: [] },
      { id: 39, name: "GUM Soft-Picks Advanced (90ct, 3-pack)", price: "$19.79", qty: 1, freq: "5 months", alternatives: [] },
      { id: 46, name: "Biotrue Contact Solution (10oz, 2-pack)", price: "$14.44", qty: 1, freq: "5 months", alternatives: [] },
      { id: 25, name: "Scotch Magic Tape (6 rolls w/ dispensers)", price: "$13.33", qty: 1, freq: "4 months", alternatives: [] },
      { id: 45, name: "Gillette Clinical Deodorant Arctic Ice (2.6 oz)", price: "$11.02", qty: 8, freq: "6 months", alternatives: [] },
      { id: 36, name: "Dr. Elsey's Ultra Unscented Cat Litter (40 lb)", price: "$20.69", qty: 4, freq: "6 months", alternatives: [] },
      { id: 19, name: "Nautica Voyage EDT (6.7 oz)", price: "$25.37", qty: 1, freq: "6 months", alternatives: [] },
      { id: 8, name: "Nescafe Taster's Choice Instant Coffee (2x 7oz)", price: "$22.92", qty: 1, freq: "6 months", alternatives: [] },
      { id: 12, name: "Sensodyne Pronamel Whitening Toothpaste (4-pack)", price: "$21.24", qty: 1, freq: "6 months", alternatives: [] },
      { id: 7, name: "Gillette ProGlide Razor Refills (8 count)", price: "$19.76", qty: 1, freq: "6 months", alternatives: [] },
      { id: 15, name: "Lysol Disinfectant Wipes (4-pack)", price: "$19.65", qty: 1, freq: "6 months", alternatives: [] },
      { id: 6, name: "Febreze AIR Linen & Sky (6-pack)", price: "$18.94", qty: 1, freq: "6 months", alternatives: [] },
      { id: 2, name: "CeraVe Foaming Facial Cleanser (19 oz)", price: "$15.27", qty: 1, freq: "6 months", alternatives: [] },
      { id: 11, name: "Energizer 123 Lithium Batteries (6 pack)", price: "$11.05", qty: 1, freq: "6 months", alternatives: [] },
      { id: 38, name: "Oral-B Glide Floss Pro-Health Mint (3-pack)", price: "$9.47", qty: 1, freq: "6 months", alternatives: [] },
      { id: 16, name: "O'Keeffe's Working Hands (3.4 oz)", price: "$9.13", qty: 1, freq: "6 months", alternatives: [] },
      { id: 23, name: "Carlyle Melatonin 12mg (180 tablets)", price: "$8.54", qty: 1, freq: "6 months", alternatives: [] },
      { id: 34, name: "Dove White Peach Body Scrub (15 oz)", price: "$6.77", qty: 1, freq: "6 months", alternatives: [] },
      { id: 4, name: "Energizer 2032 Batteries (2 count)", price: "$3.82", qty: 1, freq: "6 months", alternatives: [] },
      { id: 17, name: "Reynolds Quick Cut Plastic Wrap (225 sq ft)", price: "$3.39", qty: 1, freq: "6 months", alternatives: [] },
      { id: 42, name: "Lebanon Valley Tahineh (32 oz)", price: "", qty: 1, freq: "", note: "unavailable", alternatives: [] },
    ];

    // ========== Helpers ==========
    function parseFreqMonths(freq) {
      if (!freq) return Infinity;
      const match = freq.match(/(\d+)\s*month/);
      return match ? parseInt(match[1]) : Infinity;
    }

    function totalCost(item) {
      const p = parseFloat(item.price.replace('$', ''));
      return isNaN(p) ? 0 : p * item.qty;
    }

    function freqGroupKey(item) {
      const m = parseFreqMonths(item.freq);
      if (m >= 1 && m <= 3) return m;
      if (m >= 4 && m <= 5) return 4;
      if (m === 6) return 6;
      return 99;
    }

    function freqGroupLabel(key) {
      return { 1: 'Every month', 2: 'Every 2 months', 3: 'Every 3 months', 4: 'Every 4\u20135 months', 6: 'Every 6 months', 99: 'Special' }[key] || 'Other';
    }

    // ========== Firebase ==========
    const firebaseConfig = {
      apiKey: "AIzaSyDmkRRociBxezM-EMquIZEhClIt9QKNEJo",
      authDomain: "sns-ibendavi.firebaseapp.com",
      databaseURL: "https://amazon-sns-ibendavi-default-rtdb.firebaseio.com",
      projectId: "amazon-sns-ibendavi",
      storageBucket: "amazon-sns-ibendavi.firebasestorage.app",
      messagingSenderId: "220407199939",
      appId: "1:220407199939:web:22bd1bb1ffa53bb8e6ca76"
    };

    let db = null;
    let selectionsRef = null;
    let sendQueueRef = null;
    let cancelQueueRef = null;
    let priceDataRef = null;
    let firebaseReady = false;

    function initFirebase() {
      if (!firebaseConfig.apiKey) return;
      try {
        firebase.initializeApp(firebaseConfig);
        firebase.auth().signInAnonymously().then(() => {
          db = firebase.database();
          selectionsRef = db.ref('selections');
          sendQueueRef = db.ref('sendQueue');
          cancelQueueRef = db.ref('cancelQueue');
          priceDataRef = db.ref('priceData');
          firebaseReady = true;

          // Connection status indicator
          db.ref('.info/connected').on('value', snap => {
            const dot = document.getElementById('syncDot');
            if (snap.val() === true) {
              dot.classList.add('connected');
              dot.title = 'Synced';
            } else {
              dot.classList.remove('connected');
              dot.title = 'Offline';
            }
          });

          // Listen for changes from other clients
          selectionsRef.on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            let changed = false;
            items.forEach(item => {
              if (data[item.id] !== undefined && state[item.id] !== data[item.id]) {
                state[item.id] = data[item.id];
                changed = true;
              }
            });
            if (changed) {
              saveToLocalStorage();
              renderItems(currentFilter());
            }
          });

          // Sync cancelQueue from Firebase
          cancelQueueRef.on('value', snapshot => {
            const data = snapshot.val();
            if (data) {
              cancelQueue = data;
              localStorage.setItem('sns-cancel-queue', JSON.stringify(cancelQueue));
              renderItems(currentFilter());
            }
          });

          // Load price data from Firebase (written by scraper)
          priceDataRef.on('value', snapshot => {
            const data = snapshot.val();
            if (!data) return;
            priceData = data;
            items.forEach(item => {
              const pd = priceData[item.id];
              if (pd) {
                if (pd.alternatives && pd.alternatives.length > 0) item.alternatives = pd.alternatives;
                if (pd.snsPrice && !item.price) item.price = '$' + pd.snsPrice.toFixed(2);
              }
            });
            renderItems(currentFilter());
          });

          // Push current state to Firebase on first connect
          const updates = {};
          items.forEach(item => { updates[item.id] = !!state[item.id]; });
          selectionsRef.update(updates);
          if (Object.keys(cancelQueue).length > 0) cancelQueueRef.update(cancelQueue);
        }).catch(err => console.warn('Firebase auth failed:', err));
      } catch (e) {
        console.warn('Firebase not configured:', e.message);
      }
    }

    // ========== State Management ==========
    function defaultState() {
      const st = {};
      items.forEach(item => {
        const m = parseFreqMonths(item.freq);
        st[item.id] = (m <= 3);
      });
      return st;
    }

    function encodeState(st) {
      return items.filter(i => !st[i.id]).map(i => i.id).join(',');
    }

    function decodeHash(hash) {
      const st = {};
      items.forEach(i => st[i.id] = true);
      if (hash) {
        hash.split(',').forEach(s => {
          const n = parseInt(s);
          if (!isNaN(n)) st[n] = false;
        });
      }
      return st;
    }

    function loadState() {
      const hash = window.location.hash;
      if (hash.startsWith('#s=')) {
        const st = decodeHash(hash.substring(3));
        localStorage.setItem('sns-selections', JSON.stringify(st));
        return st;
      }
      const saved = localStorage.getItem('sns-selections');
      if (saved) return JSON.parse(saved);
      return defaultState();
    }

    function saveToLocalStorage() {
      localStorage.setItem('sns-selections', JSON.stringify(state));
    }

    function saveState() {
      saveToLocalStorage();
      const enc = encodeState(state);
      history.replaceState(null, '', enc ? '#s=' + enc : window.location.pathname);
    }

    let state = loadState();
    let altPreferences = JSON.parse(localStorage.getItem('sns-alt-prefs') || '{}');
    let cancelQueue = JSON.parse(localStorage.getItem('sns-cancel-queue') || '{}');
    let priceData = {};

    window.addEventListener('hashchange', () => {
      state = loadState();
      renderItems(currentFilter());
    });

    // ========== Rendering ==========
    function currentFilter() {
      const el = document.querySelector('.search');
      return el ? el.value : '';
    }

    function renderItems(filter = '') {
      const list = document.getElementById('itemList');
      list.innerHTML = '';
      const lf = filter.toLowerCase();
      let idx = 0;
      let lastGroup = null;

      items.forEach(item => {
        if (filter && !item.name.toLowerCase().includes(lf)) return;

        // Group divider (only when not filtering)
        const gk = freqGroupKey(item);
        if (gk !== lastGroup && !filter) {
          lastGroup = gk;
          const div = document.createElement('li');
          div.className = 'group-divider';
          div.textContent = freqGroupLabel(gk);
          list.appendChild(div);
        }

        idx++;
        const checked = state[item.id];
        const isCancelled = !!cancelQueue[item.id];
        const li = document.createElement('li');
        li.className = 'item' + (checked ? '' : ' unchecked') + (isCancelled ? ' cancelled' : '');

        let noteHtml = '';
        if (item.note === 'unavailable') noteHtml = '<span class="unavailable">Temporarily Unavailable</span>';
        if (item.note === 'vet') noteHtml = '<span class="vet-note">Vet approval required</span>';

        // Alternative preference indicator
        const prefAlt = altPreferences[item.id];
        const prefHtml = prefAlt ? `<span class="pref-alt">\u2192 ${prefAlt}</span>` : '';

        // Alternatives expandable section
        let altHtml = '';
        if (item.alternatives && item.alternatives.length > 0) {
          const altId = 'alt-' + item.id;
          altHtml = `<div class="alt-toggle" onclick="toggleAlts('${altId}')">Alternatives (${item.alternatives.length})</div>`;
          altHtml += `<div class="alt-list" id="${altId}">`;
          item.alternatives.forEach(alt => {
            const isSelected = altPreferences[item.id] === alt.name;
            const escapedName = alt.name.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            altHtml += `
              <div class="alt-item">
                <div class="alt-info">
                  <div class="alt-name">${alt.name}</div>
                  <div class="alt-meta">${alt.price} &middot; ${alt.unitPrice}${alt.note ? ' &middot; ' + alt.note : ''}</div>
                  ${alt.savings ? '<div class="alt-savings">' + alt.savings + '</div>' : ''}
                </div>
                <button class="alt-switch${isSelected ? ' selected' : ''}" onclick="switchAlt(${item.id}, '${escapedName}')">
                  ${isSelected ? 'Selected' : 'Switch'}
                </button>
              </div>`;
          });
          altHtml += '</div>';
        }

        // Price badge from scraper data
        const pd = priceData[item.id];
        let badgeHtml = '';
        if (pd && pd.savingsPct) badgeHtml = `<span class="price-badge">S&amp;S saves ${pd.savingsPct}%</span>`;

        li.innerHTML = `
          <span class="item-num">${idx}</span>
          <input type="checkbox" ${checked ? 'checked' : ''} onchange="toggle(${item.id}, this.checked)" id="cb-${item.id}">
          <div class="item-details">
            <div class="item-name">${item.name}${prefHtml}${isCancelled ? '<span class="cancel-label">Pending cancellation</span>' : ''}</div>
            <div class="item-meta">${item.freq ? 'Every ' + item.freq : ''}${item.qty > 1 ? ' &middot; Qty: ' + item.qty : ''} ${noteHtml}${badgeHtml}</div>
            ${altHtml}
          </div>
          <span class="item-price">${item.price}</span>
          ${!isCancelled ? `<button class="cancel-btn" onclick="cancelItem(${item.id})" title="Cancel subscription">&times;</button>` : ''}
        `;
        list.appendChild(li);
      });

      document.getElementById('itemCount').textContent = items.length;
      updateSummary();
    }

    // ========== Actions ==========
    function toggle(id, checked) {
      state[id] = checked;
      saveState();
      if (firebaseReady) selectionsRef.child(String(id)).set(checked);
      renderItems(currentFilter());
    }

    function selectAll() {
      items.forEach(i => state[i.id] = true);
      saveState();
      if (firebaseReady) {
        const u = {};
        items.forEach(i => { u[i.id] = true; });
        selectionsRef.update(u);
      }
      renderItems(currentFilter());
    }

    function deselectAll() {
      items.forEach(i => state[i.id] = false);
      saveState();
      if (firebaseReady) {
        const u = {};
        items.forEach(i => { u[i.id] = false; });
        selectionsRef.update(u);
      }
      renderItems(currentFilter());
    }

    function updateSummary() {
      const kept = items.filter(i => state[i.id]);
      const skipped = items.filter(i => !state[i.id]);
      const total = kept.reduce((sum, i) => {
        const p = parseFloat(i.price.replace('$', ''));
        return sum + (isNaN(p) ? 0 : p * i.qty);
      }, 0);
      document.getElementById('summary').innerHTML = `
        <span>${kept.length}</span> items kept &mdash;
        <span>${skipped.length}</span> to skip &mdash;
        Estimated total: <span>$${total.toFixed(2)}</span>
      `;
    }

    function sendSelections() {
      const kept = items.filter(i => state[i.id]).map(i => ({ id: i.id, name: i.name }));
      const skipped = items.filter(i => !state[i.id]).map(i => ({ id: i.id, name: i.name }));
      const payload = {
        selections: Object.assign({}, state),
        altPreferences: Object.assign({}, altPreferences),
        cancelQueue: Object.assign({}, cancelQueue),
        kept: kept,
        skipped: skipped,
        timestamp: Date.now(),
        status: 'pending'
      };

      if (firebaseReady) {
        sendQueueRef.set(payload).then(() => {
          showToast('Sent! Claude Code will process your selections.');
        }).catch(err => {
          showToast('Error sending: ' + err.message);
        });
      } else {
        // Fallback: copy JSON to clipboard
        navigator.clipboard.writeText(JSON.stringify(payload, null, 2)).then(() => {
          showToast('Copied to clipboard (Firebase offline). Paste into Claude Code.');
        }).catch(() => {
          console.log('Send payload:', payload);
          showToast('Logged to console. Check DevTools.');
        });
      }
    }

    function toggleAlts(id) {
      const el = document.getElementById(id);
      if (el) el.classList.toggle('open');
    }

    function switchAlt(itemId, altName) {
      if (altPreferences[itemId] === altName) {
        delete altPreferences[itemId];
      } else {
        altPreferences[itemId] = altName;
      }
      localStorage.setItem('sns-alt-prefs', JSON.stringify(altPreferences));
      renderItems(currentFilter());
    }

    function cancelItem(id) {
      const item = items.find(i => i.id === id);
      if (!item) return;
      if (cancelQueue[id]) {
        // Already cancelled â€” offer to undo
        if (confirm('Undo cancellation for "' + item.name + '"?')) {
          delete cancelQueue[id];
          localStorage.setItem('sns-cancel-queue', JSON.stringify(cancelQueue));
          if (firebaseReady) cancelQueueRef.child(String(id)).remove();
          renderItems(currentFilter());
          showToast('Cancellation undone.');
        }
        return;
      }
      if (!confirm('Cancel subscription for "' + item.name + '"?')) return;
      cancelQueue[id] = { name: item.name, timestamp: Date.now() };
      localStorage.setItem('sns-cancel-queue', JSON.stringify(cancelQueue));
      if (firebaseReady) cancelQueueRef.child(String(id)).set(cancelQueue[id]);
      renderItems(currentFilter());
      showToast('Marked for cancellation. Click Send to confirm.');
    }

    function filterItems(val) {
      renderItems(val);
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ========== Init ==========
    initFirebase();
    renderItems();
  </script>
</body>
</html>
